datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id         String   @id @default(cuid())
  email      String?  @unique
  handle     String?  @unique
  displayName String?
  avatarUrl  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  following  Follow[] @relation("following")
  followers  Follow[] @relation("followers")

  blocking   Block[]  @relation("blocking")
  blockedBy  Block[]  @relation("blockedBy")
}

model Follow {
  followerId String
  followeeId String
  createdAt  DateTime @default(now())

  follower   User @relation("following", fields: [followerId], references: [id], onDelete: Cascade)
  followee   User @relation("followers", fields: [followeeId], references: [id], onDelete: Cascade)

  @@id([followerId, followeeId])
  @@index([followeeId, createdAt])
  @@index([followerId, createdAt])
}

model Block {
  blockerId String
  blockeeId String
  createdAt DateTime @default(now())

  blocker   User @relation("blocking", fields: [blockerId], references: [id], onDelete: Cascade)
  blockee   User @relation("blockedBy", fields: [blockeeId], references: [id], onDelete: Cascade)

  @@id([blockerId, blockeeId])
  @@index([blockeeId, createdAt])
  @@index([blockerId, createdAt])
}


model Clan {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  visibility  String // "public" | "private"
  description String?  // Contract: optional clan description
  avatarUrl   String?  // Contract: optional clan avatar (coverUrl kept for backward compat)
  coverUrl    String?
  settings    Json?
  createdBy   String
  createdAt   DateTime @default(now())

  members     ClanMember[]
  invites     ClanInvite[]
  joinRequests ClanJoinRequest[]
}

model ClanMember {
  clanId   String
  userId   String
  role     String // "leader" | "officer" | "member"
  status   String // "active" | "banned" | "left" | "pending"
  joinedAt DateTime @default(now())
  
  clan     Clan @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@id([clanId, userId])
  @@index([userId])
  @@index([clanId, status])
}

model ClanInvite {
  id        String   @id @default(cuid())
  clanId    String
  inviterId String
  inviteeId String?
  token     String   @unique
  expiresAt DateTime
  status    String   // "pending" | "accepted" | "revoked" | "expired"
  createdAt DateTime @default(now())
  
  clan      Clan @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@index([clanId])
}

model ClanJoinRequest {
  id          String   @id @default(cuid())
  clanId      String
  requesterId String
  status      String   // "pending" | "approved" | "rejected"
  reviewedBy  String?
  reviewedAt  DateTime?
  createdAt   DateTime @default(now())
  
  clan        Clan @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@unique([clanId, requesterId])
  @@index([clanId, status])
}

model Report {
  id          String   @id @default(cuid())
  subjectType String   // "message" | "clan" | "user"
  subjectId   String
  reporterId  String
  reason      String
  status      String   // "open" | "resolved" | "invalid"
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?
}